version: '3.8'

services:
  base_code:
    build:
      context: .
      dockerfile: docker/images/base/Dockerfile.base_code
    image: youtube-channel-summarizer-base-code:latest
    depends_on:
      - base_requirements

  orchestrator_service:
    build:
      context: .
      dockerfile: docker/images/services/orchestrator_service/Dockerfile.service_code
    image: youtube-channel-summarizer-orchestrator-service-code:latest
    ports:
      - "5000:5000"
    depends_on:
      base_code:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - youtube-summarizer-net

  discovery_service:
    build:
      context: .
      dockerfile: docker/images/services/discovery_service/Dockerfile.service_code
    image: youtube-channel-summarizer-discovery-service-code:latest
    depends_on:
      base_code:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - shared_data:/app/data
    networks:
      - youtube-summarizer-net

  download_service:
    build:
      context: .
      dockerfile: docker/images/services/download_service/Dockerfile.service_code
    image: youtube-channel-summarizer-download-service-code:latest
    depends_on:
      download_service_requirements:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - shared_data:/app/data
    networks:
      - youtube-summarizer-net

  transcription_service:
    build:
      context: .
      dockerfile: docker/images/services/transcription_service/Dockerfile.service_code
    image: youtube-channel-summarizer-transcription-service-code:latest
    depends_on:
      transcription_service_requirements:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - shared_data:/app/data
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - IS_OPENAI_RUNTIME=${IS_OPENAI_RUNTIME:-true}
    networks:
      - youtube-summarizer-net

  summarization_service:
    build:
      context: .
      dockerfile: docker/images/services/summarization_service/Dockerfile.service_code
    image: youtube-channel-summarizer-summarization-service-code:latest
    depends_on:
      summarization_service_requirements:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - shared_data:/app/data
    env_file:
      - .env
    networks:
      - youtube-summarizer-net
  
  logging_service:
    build:
      context: .
      dockerfile: docker/images/services/logging_service/Dockerfile.service_code
    image: youtube-channel-summarizer-logging-service-code:latest
    depends_on:
      base_code:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    networks:
      - youtube-summarizer-net
  
  analytics_service:
    build:
      context: .
      dockerfile: docker/images/services/analytics_service/Dockerfile.service_code
    image: youtube-channel-summarizer-analytics-service-code:latest
    depends_on:
      base_code:
        condition: service_started
      kafka:
        condition: service_healthy
    networks:
      - youtube-summarizer-net

networks:
  youtube-summarizer-net:
    driver: bridge

volumes:
  postgres_data:
  mongo_data:
  shared_data:
